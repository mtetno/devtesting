<!DOCTYPE html>
<html>
<head>
	<title>UInium</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<!--Favicon-->
	<link rel="icon" href="img/favicon-16x16.png">

	<!--Styles-->
	<link rel="stylesheet" href="css/bootstrap.min.css">
	<link rel="stylesheet" href="css/font-awesome.min.css">
	<!--Custom style link-->
	<link rel="stylesheet" href="css/custom.css">
	<style>
		.card, .card-body, .section-box {
			border: 0px !important;
		}

		.canvasjs-chart-credit {
			display: none;
		}
	</style>
</head>
<body>
	<!--Header Start-->
	<header class="navbar navbar-expand-lg">
		<!--Logo Start-->
		<a id="logo" class="navbar-brand text-center" href="#">
			<img src="img/4317-converted.png">
		</a>
		<!--Logo End-->
		<!--Navbar Toggle Start-->
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
		    <span class="fa fa-bars"></span>
		</button>
		<!--Navbar Toggle End-->
		<div class="collapse navbar-collapse" id="navbarText">
			<ul class="navbar-nav mr-auto">
				<li class="nav-item"><a class="nav-link" href="dashboard1.html"><img src="img/insert-chart-outlined-24-px.png"> Monitor App</a></li>
				<li class="nav-item"><a class="nav-link" href="subscription.html"><img src="img/stars-24-px.png"> Subscriptions</a></li>
				<li class="nav-item"><a class="nav-link" href="emailcofiguration.html"><img src="img/email-24-px.png"> Email Configuration</a></li>
				<li class="nav-item"><a class="nav-link" href="managetestcase.html"><img src="img/assignment-24-px.png"> Manage Test Cases</a></li>
			</ul>

			<!--User Menu Start-->
			<div id="userMenu" class="dropdown">
				<!-- <a href="#"><i class="fa fa-user-o"></i> User</a> -->
				<a href="#" class="dropdown-toggle" data-toggle="dropdown"><img src="img/account-circle-24-px.png"> <span>User</span></a>
				<div class="dropdown-menu">
			      <a class="dropdown-item" href="profileAdmin.html">Profile</a>
			      <a class="dropdown-item" href="login.html">Logout</a>
			    </div>
			</div>
			<!--User Menu End-->
		</div>
	</header>
	<!--Header End-->

	<!--Sidebar Start-->
	<aside class="sidebar pull-left">
		<ul>
			<!-- <li><a href="#"><img src="img/add-24-px.png"></a></li>
			<li><a href="#"><i class="fa fa-plus"></i></a></li> -->
			<li><a href="#"><img src="img/apps-24-px.png"></a></li>
			<li><a href="#"><img src="img/add-24-px.png"></a></li>
		</ul>
	</aside>
	<!--Sidebar End-->

	<!--Main Contebt Start-->
	<div id="main-content" class="container-fluid pull-right">
		<!--Page Title-->
		<!-- <h1 id="page-title">Monitor App</h1> -->

        <!--Section for fill information-->
		<div class="card">
			<div class="card-body">
				<div class="row mt-4 section-box3">
					<div class="col-md-12 stackcols">
						<div class="col-md-12 col-sm-12 col-xs-12 mb-2">
							<label class="subtitle">Stacked column chart</label>
								<ul id="stackBarAppNames">
				                  
				                </ul>
							</div>
	                    <div id="chartContainer" style="height: 300px; width: 100%;">
						</div>
					</div>
			    </div>
				<div class="row mt-4 section-box3">
					<div class="col-md-12">
						<div class="col-md-12 col-sm-12 col-xs-12">
						<label class="subtitle">Subscriber Table</label>
					</div>
                    <table id="" class="table tabledash">
		                <thead>
		                  <tr>
		                    <th scope="col">SUBSCRIPTION</th>
		                    <th scope="col">EXPIRY IN</th>
		                    <th scope="col">NOTIFICATION</th>
		                    <th scope="col">START DATE</th>
		                    <th scope="col">END DATE</th>
		                    <th scope="col">ACTIONS</th>
		                  </tr>
		                </thead>
		                <tbody>
		                 
		                </tbody>
		              </table>
					</div>
				</div>

				<div class="modal fade" id="myModalSucess">
				    <div class="modal-dialog modal-dialog-centered">
				      <div class="modal-content">

				        <!-- Modal Header -->
				        <div class="modal-header model_head">
				          <h4 class="modal-title"></h4>
				          <button type="button" class="close" data-dismiss="modal">&times;</button>
				        </div>

				        <!-- Modal body -->
				        <div class="modal-body model_body">
				          <i class="fa fa-check-circle"></i><span><strong>Success</strong></span><br>
				          <p>The email sent successfully to subscriber.</p>
				        </div>

				        <!-- Modal footer -->
				        <div class="modal-footer btnfooter">
				          <button type="button" class="btn btn-dark btnclose" data-dismiss="modal">CLOSE</button>
				        </div>

				      </div>
				    </div>
				  </div>
			</div>
		</div>
	</div>
	<!--Main Content End-->

	<!--Footer Start-->
	<footer id="footer" class="container-fluid pull-right">
		<div class="pull-left footer-logo"><img src="img/logo-11.png"></div>
		<div class="pull-right footer-text">
			<!-- &copy <script>document.write((new Date()).getFullYear());</script>   -->
			Copyright @ 2020 UInium(“UI automation Studio”). All Rights Reserved.
		</div>
	</footer>
   <!--Footer End-->
	<!-- For sidebar toggle -->
	<a href="#" id="sidebarToggle"><i class="fa fa-caret-right fa-2x" aria-hidden="true"></i></a>
	<!--Footer End-->

	<!--Scripts-->
	<script src="js/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/moment.js"></script>
	<script src="js/custom.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js"></script>
	<script type="text/javascript" src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>

<script type="text/javascript">
  window.onload = function () {

	var colorSet = ["#3ebbf6","#ffc637","#7933af"]


	var stackData = undefined;
	var apps = undefined;
	var companies = undefined;

	$(document).ready(function() {	

	var uname = readCookie("TAuname");
	$("#userMenu span").text(uname);
	});


	// fetchStackData();
	fetchSubscriptionTable();

	function fetchStackData() {
	$.ajax({
		type: 'GET',
		contentType: 'application/json',
		dataType: 'json',
		url: base_url + "/testcases/getTestcasesStackedApplicationData",
		beforeSend: function (xhr) {
			xhr.setRequestHeader('Authorization', "Bearer " + readCookie("TAaccess"));
		},
		success: function (stkData) {
			stackData = stkData;
			$.ajax({
				type: 'GET',
				contentType: 'application/json',
				dataType: 'json',
				url: base_url + "/testcases/getTestcasesStackedApplicationData/applications",
				beforeSend: function (xhr) {
					xhr.setRequestHeader('Authorization', "Bearer " + readCookie("TAaccess"));
				},
				success: function (applications) {
					apps = applications;
					$.ajax({
						type: 'GET',
						contentType: 'application/json',
						dataType: 'json',
						url: base_url + "/testcases/getTestcasesStackedApplicationData/companies",
						beforeSend: function (xhr) {
							xhr.setRequestHeader('Authorization', "Bearer " + readCookie("TAaccess"));
						},
						success: function (comps) {
							companies = comps;
							plotGraph();
						}
					});
				}
			});
		}
	});
}

	function plotGraph(){
		var inputData = {
      title:{
      // text: "Coal Reserves of Countries"
      },
      axisY:{
		title:"Test Case number",
		valueFormatString: " ",
	  },
	  toolTip:{
	  	shared: true,
		content: toolTipContent
	   // content:"{label},<br> x: {city},</br> y: {y}" ,
	 },
	  dataPointWidth: 50
	};
	
	
	var graphData = [];
	apps.map((app,index) => {
		$("#stackBarAppNames").append("<li><i></i><span><strong>"+app.name+"</strong></span></li>")
		var dataPoints = [];
		companies.map((company,idx)=>{
			var appData = stackData[app.id];
			var compData = _.find(appData,{company_id:company.id})
			if(compData !=undefined ){
				dataPoints.push({y : compData.count , label : company.name})
			}else{
				dataPoints.push({y : 0 , label : company.name})
			}
		})

		graphData.push({
        type: "stackedColumn",
        showInLegend: true,
        color:colorSet[index],
        indexLabel: "{y}",
        name: app.name,
        dataPoints: dataPoints
      })
	})



	inputData['data'] = graphData;
	var chart = new CanvasJS.Chart("chartContainer", inputData);

    chart.render();

    function toolTipContent(e) {
		var str = "";
		var total = 0;
		var str2, str3;
		for (var i = 0; i < e.entries.length; i++){
			var  str1 = "<span style= \"color:"+e.entries[i].dataSeries.color + "\"> "+e.entries[i].dataSeries.name+"</span>: <strong>"+e.entries[i].dataPoint.y+"</strong><br/>";
			total = e.entries[i].dataPoint.y + total;
			str = str.concat(str1);
		}
		str2 = "<span style = \"color:#212529;\"><strong>"+(e.entries[0].dataPoint.label)+"</strong></span><br/>";
		total = Math.round(total * 100) / 100;
		str3 = "<span style = \"color:#212529\">Total:</span><strong> "+total+"</strong><br/>";
		return str.concat(str3);
	}

	}

	function fetchSubscriptionTable(){
		$.ajax({
				type: 'GET',
				contentType: 'application/json',
				dataType: 'json',
				url: base_url + "/subscriptions/all",
				beforeSend: function (xhr) {
					xhr.setRequestHeader('Authorization', "Bearer " + readCookie("TAaccess"));
				},
				success: function (subscriptions) {
					$(".tabledash tbody").html("");
					subscriptions.map((subp,index)=>{

						var str = `
						<tr>
		                    <td >`+subp.company_name+`</td>
		                    <td >`+expiresIn(subp.end_date,subp.remind_before)+` Days</td>
		                    <td >`+subp.remind_before+` Days</td>
		                    <td >`+subp.start_date+`</td>
		                    <td >`+subp.end_date+`</td>
		                    <td ><img src="img/shapemail.png" alt="1" data-toggle="modal" data-dismiss="modal" data-target="#myModalSucess"></td>
		                  </tr>
						`;

						$(".tabledash tbody").prepend(str);
					})
					
					 
				}
			});
	}



	function expiresIn(endDate,remind){
		var endDay = toDate(endDate);
		return parseInt((endDay - new Date()) / (1000 * 60 * 60 * 24), 10);
	}

	function isInExpired(endDate,remind){
		var endDay = toDate(endDate);
		var withReminder = new Date();
		withReminder.setDate(endDay.getDate() - remind);
		var diffDays = parseInt((withReminder - new Date()) / (1000 * 60 * 60 * 24), 10);
		return diffDays > 0 ? true : false;
	}

	function toDate(dateStr) {
		var parts = dateStr.split("-")
		return new Date(parts[2], parts[1] - 1, parts[0])
	}



    
  }
  </script>
</body>
</html>